{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://ai-trade-analyst.local/schema/ticket.schema.json",
  "title": "AI Trade Analyst Ticket",
  "description": "Canonical trade ticket payload for export/import and persistence. v3.0.0 adds G8 fields: aiEdgeScore (AI predicted confidence from response) and revisedFromId (parent ticket linkage).",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schemaVersion",
    "ticketId",
    "createdAt",
    "counterTrendMode",
    "decisionMode",
    "ticketType",
    "entryType",
    "entryTrigger",
    "confirmationTF",
    "timeInForce",
    "maxAttempts",
    "entry",
    "stop",
    "targets",
    "checklist",
    "gate",
    "edgeScore",
    "psychologicalLeakR",
    "screenshots"
  ],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "const": "3.0.0"
    },
    "counterTrendMode": {
      "type": "string",
      "enum": ["Strict HTF-only", "Mixed", "Full OK"],
      "description": "Whether the analyst may propose counter-trend ideas. Strict HTF-only = no counter-trend; Mixed = allowed if strongly justified; Full OK = any direction."
    },
    "rawAIReadBias": {
      "type": "string",
      "enum": ["", "Bullish", "Bearish", "Neutral", "Range"],
      "description": "The AI's raw bias verdict from its chart narrative (filled by user after reading AI response). Empty string = not yet recorded."
    },
    "ticketId": { "type": "string", "minLength": 1 },
    "createdAt": { "type": "string", "format": "date-time" },
    "decisionMode": {
      "type": "string",
      "enum": ["LONG", "SHORT", "WAIT", "CONDITIONAL"]
    },
    "ticketType": {
      "type": "string",
      "enum": ["Zone ticket", "Exact ticket"]
    },
    "entryType": {
      "type": "string",
      "enum": ["Market", "Limit", "Stop"]
    },
    "entryTrigger": {
      "type": "string",
      "enum": [
        "Pullback to zone",
        "Break + retest",
        "Sweep + reclaim",
        "Close above/below level",
        "Momentum shift (MSS/BOS)"
      ]
    },
    "confirmationTF": {
      "type": "string",
      "enum": ["1m", "5m", "15m", "1H"]
    },
    "timeInForce": {
      "type": "string",
      "enum": ["This session", "Next 1H", "24H", "Custom"]
    },
    "maxAttempts": {
      "type": "integer",
      "minimum": 1,
      "maximum": 3
    },
    "entry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["zone", "priceMin", "priceMax", "notes"],
      "properties": {
        "zone": { "type": "string", "minLength": 1 },
        "priceMin": { "type": "number" },
        "priceMax": { "type": "number" },
        "notes": { "type": "string" }
      }
    },
    "stop": {
      "type": "object",
      "additionalProperties": false,
      "required": ["price", "logic", "rationale"],
      "properties": {
        "price": { "type": "number" },
        "logic": {
          "type": "string",
          "enum": [
            "Below swing low / above swing high",
            "Below zone",
            "ATR-based",
            "Structure-based + buffer"
          ]
        },
        "rationale": { "type": "string", "minLength": 1 }
      }
    },
    "targets": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["label", "price", "rationale"],
        "properties": {
          "label": { "type": "string", "enum": ["TP1", "TP2", "TP3"] },
          "price": { "type": "number" },
          "rationale": { "type": "string", "minLength": 1 }
        }
      }
    },
    "checklist": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "htfState",
        "htfLocation",
        "ltfAlignment",
        "liquidityContext",
        "volRisk",
        "execQuality",
        "conviction",
        "edgeTag",
        "confluenceScore"
      ],
      "properties": {
        "htfState": { "type": "string", "enum": ["Trending", "Ranging", "Transition"] },
        "htfLocation": { "type": "string", "enum": ["At POI", "Mid-range", "At extremes"] },
        "ltfAlignment": { "type": "string", "enum": ["Aligned", "Counter-trend", "Mixed"] },
        "liquidityContext": { "type": "string", "enum": ["Near obvious highs/lows", "Equilibrium", "None identified"] },
        "volRisk": { "type": "string", "enum": ["Normal", "Elevated"] },
        "execQuality": { "type": "string", "enum": ["Clean", "Messy", "Chop"] },
        "conviction": { "type": "string", "enum": ["Very High", "High", "Medium", "Low"] },
        "edgeTag": {
          "type": "string",
          "enum": ["High-probability pullback", "Liquidity grab", "FVG reclaim", "Structure BOS", "Range boundary", "Other"]
        },
        "confluenceScore": { "type": "integer", "minimum": 1, "maximum": 10 }
      }
    },
    "gate": {
      "type": "object",
      "additionalProperties": false,
      "required": ["status", "waitReasonCode", "reentryCondition", "reentryTime"],
      "properties": {
        "status": { "type": "string", "enum": ["INCOMPLETE", "PROCEED", "CAUTION", "WAIT"] },
        "waitReasonCode": {
          "type": "string",
          "enum": ["", "Chop / range noise", "HTF-LTF conflict", "No POI / poor R:R", "News risk / volatility", "Already moved / late trend"]
        },
        "reentryCondition": { "type": "string" },
        "reentryTime": { "type": "string" }
      }
    },
    "edgeScore": {
      "type": "number",
      "description": "Computed process edge score. In G6 this is persisted from AAR score display for analytics stability."
    },
    "psychologicalLeakR": {
      "type": "number",
      "description": "Absolute R leaked due to psychology-linked execution mistakes. 0 when not detected."
    },
    "aiEdgeScore": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "G8: AI's predicted confidence/edge score recorded from the AI response (0.0–1.0). Optional — omitted if not recorded."
    },
    "revisedFromId": {
      "type": "string",
      "minLength": 1,
      "description": "G8: Ticket ID of the parent ticket this revision is based on. Optional — present only on revised tickets."
    },
    "screenshots": {
      "type": "object",
      "description": "Typed evidence metadata for all screenshots submitted with this ticket. Architecture: max 3 clean price charts + 1 optional 15M ICT overlay (4 total hard cap).",
      "additionalProperties": false,
      "required": ["cleanCharts"],
      "properties": {
        "cleanCharts": {
          "type": "array",
          "description": "Metadata for each clean price chart. Maximum 3 (H4/H1 for HTF bias, M15 for structure, M5 for entry context).",
          "minItems": 1,
          "maxItems": 3,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["timeframe", "lens", "evidenceType"],
            "properties": {
              "timeframe": {
                "type": "string",
                "enum": ["H4", "H1", "M15", "M5"],
                "description": "Timeframe of this clean price chart."
              },
              "lens": {
                "type": "string",
                "const": "NONE",
                "description": "Clean price charts must have lens=NONE."
              },
              "evidenceType": {
                "type": "string",
                "const": "price_only",
                "description": "Clean price charts must have evidenceType=price_only."
              }
            }
          }
        },
        "m15Overlay": {
          "type": ["object", "null"],
          "description": "Metadata for the optional 15M ICT indicator overlay screenshot. Null when not provided. Triggers two-phase isolated analysis when present.",
          "additionalProperties": false,
          "required": ["timeframe", "lens", "evidenceType", "indicatorClaims", "indicatorSource", "settingsLocked"],
          "properties": {
            "timeframe": {
              "type": "string",
              "const": "M15",
              "description": "Overlay is bound to M15 only. No other timeframe may carry an overlay."
            },
            "lens": {
              "type": "string",
              "const": "ICT",
              "description": "The single overlay slot uses the ICT lens."
            },
            "evidenceType": {
              "type": "string",
              "const": "indicator_overlay",
              "description": "The overlay slot must have evidenceType=indicator_overlay."
            },
            "indicatorClaims": {
              "type": "array",
              "description": "Construct types the overlay claims to identify (e.g. FVG, OrderBlock, SessionLiquidity).",
              "minItems": 1,
              "items": { "type": "string" }
            },
            "indicatorSource": {
              "type": "string",
              "minLength": 1,
              "description": "Platform or script providing the ICT overlay (e.g. TradingView)."
            },
            "settingsLocked": {
              "type": "boolean",
              "description": "Confirms indicator settings are locked and consistent across sessions. Must be true for comparability of delta reports."
            }
          }
        }
      }
    }
  }
}
