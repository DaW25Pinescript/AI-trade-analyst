# ─────────────────────────────────────────────────────────────────────────────
# AI Trade Analyst – docker-compose.yml
#
# Services:
#   ai-analyst-api  → FastAPI multi-model pipeline        (host port 8000)
#   app-static      → Static file server for browser UI   (host port 8080)
#
# Quick start:
#   docker compose up            # start both services
#   docker compose up --wait     # start and wait until healthy
#   docker compose up --build    # rebuild after dependency changes
#
# Access:
#   API:  http://localhost:8000  (POST /analyse, GET /health)
#   App:  http://localhost:8080/app/
#
# API keys:
#   Copy ai_analyst/.env.example → ai_analyst/.env and fill in your keys.
#   The api service picks them up automatically via the env_file directive.
# ─────────────────────────────────────────────────────────────────────────────
services:

  # ── FastAPI multi-model trade analysis pipeline ───────────────────────────
  # Built from the repo Dockerfile so pip install runs at build time, not
  # at every container start. Rebuild with: docker compose up --build
  # Health endpoint: GET /health → {"status": "ok", "version": "..."}
  ai-analyst-api:
    build: .

    working_dir: /workspace

    command: uvicorn ai_analyst.api.main:app --host 0.0.0.0 --port 8000

    env_file:
      - path: ./ai_analyst/.env
        required: false   # silently skipped when .env is absent

    volumes:
      # Mount the live source tree for hot-reload during development.
      - ./:/workspace

    ports:
      # 8000 → FastAPI (POST /analyse, GET /health)
      - "8000:8000"

    restart: on-failure

    healthcheck:
      # stdlib urllib avoids requiring curl/wget in the slim image.
      test:
        - "CMD"
        - "python"
        - "-c"
        - "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"
      interval: 30s
      timeout: 10s
      retries: 3
      # pip no longer runs at startup — allow only uvicorn cold-start time.
      start_period: 15s

  # ── Static file server for the browser UI ────────────────────────────────
  # Serves the repo root over HTTP so the trade ticket UI is reachable at
  # http://localhost:8080/app/
  app-static:
    image: python:3.11-slim

    working_dir: /workspace

    command: python -m http.server 8080

    volumes:
      # Same mount as ai-analyst-api so both share the identical repo root.
      - ./:/workspace

    ports:
      # 8080 → static HTTP (directory listing / app/)
      - "8080:8080"

    depends_on:
      # Wait for the API container to start before bringing up the static server.
      # Using service_started (not service_healthy) so the UI is accessible
      # even when the API health check is still warming up.
      ai-analyst-api:
        condition: service_started

    healthcheck:
      # python http.server returns HTTP 200 for a directory listing request.
      test:
        - "CMD"
        - "python"
        - "-c"
        - "import urllib.request; urllib.request.urlopen('http://localhost:8080/')"
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
