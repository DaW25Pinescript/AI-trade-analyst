<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Trade Analyst — V3</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./styles/theme.css">
<link rel="stylesheet" href="./styles/dashboard.css">
<link rel="stylesheet" href="./styles/print.css" media="print">
</head>
<body>

<header class="header">
  <div class="header-left">
    <div class="logo">AI Trade <span>/ Analyst</span></div>
    <div class="version-pill">V3 · G9</div>
    <button id="operatorModeBtn" class="operator-mode-btn" onclick="toggleOperatorDashboard()" aria-pressed="false">Operator Dashboard: OFF</button>
    <div id="shadowBadge" style="display:none;font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:600;letter-spacing:0.12em;padding:4px 10px;border-radius:2px;background:rgba(59,111,255,0.15);border:1px solid rgba(59,111,255,0.5);color:var(--accent);">SHADOW</div>
  </div>
  <div class="ticket-id-header">Ticket: <span id="ticketIdHeader">—</span></div>
</header>

<main class="main">
  <div class="page-title">Market Analysis Request</div>
  <h1>Build Your Analysis Brief</h1>
  <p class="subtitle">G9 — Shadow Mode: paper trades with zero capital risk, 24h/48h outcome capture, and AI edge calibration</p>

  <section id="operatorDashboard" class="operator-dashboard" aria-label="Operator dashboard mode" hidden>
    <article class="dash-card dash-chart-card">
      <div class="dash-card-header">
        <h2>Chart Viewer</h2>
        <div class="dash-toolbar">
          <button class="dash-tab active" type="button" data-tf="D" aria-pressed="true">D</button>
          <button class="dash-tab" type="button" data-tf="4H" aria-pressed="false">4H</button>
          <button class="dash-tab" type="button" data-tf="1H" aria-pressed="false">1H</button>
          <button class="dash-tab" type="button" data-tf="15m" aria-pressed="false">15m</button>
        </div>
      </div>
      <div class="dash-chart-stage">
        <div id="dashChartPlaceholder" class="dash-placeholder">Daily chart stream · Clean view</div>
      </div>
      <div class="dash-footer-actions">
        <button class="dash-chip-btn active" type="button" data-view="Clean" aria-pressed="true">Clean</button>
        <button class="dash-chip-btn" type="button" data-view="Lens" aria-pressed="false">Lens</button>
        <button class="dash-chip-btn" type="button" data-view="Upload" aria-pressed="false">Upload</button>
      </div>
    </article>

    <article class="dash-card dash-ruling-card">
      <div class="dash-card-header">
        <h2>Final Ruling</h2>
        <span id="dashVerdictBadge" class="dash-status-badge">No Trade</span>
      </div>
      <div class="dash-metric-stack">
        <div class="dash-metric-row"><span>Confidence</span><strong id="dashRulingConfidence">0%</strong></div>
        <div class="dash-progress"><div id="dashConfidenceFill" class="dash-progress-fill"></div></div>
        <div class="dash-metric-row"><span>Setup Quality</span><strong id="dashSetupQuality">—</strong></div>
        <div class="dash-metric-row"><span>Arbiter</span><strong id="dashArbiterState">Awaiting analysis</strong></div>
        <div class="dash-metric-row"><span>Risk Status</span><strong id="dashRiskState">Unconfirmed</strong></div>
      </div>
    </article>

    <article class="dash-card dash-context-card">
      <div class="dash-card-header"><h2>HTF Context</h2></div>
      <div class="dash-info-list">
        <div class="dash-metric-row"><span>Asset</span><strong id="dashAsset">XAUUSD</strong></div>
        <div class="dash-metric-row"><span>Session</span><strong id="dashSession">NY AM</strong></div>
        <div class="dash-metric-row"><span>Regime</span><strong id="dashRegime">Trending</strong></div>
        <div class="dash-metric-row"><span>POI</span><strong id="dashPoi">3348–3354</strong></div>
      </div>
    </article>

    <article class="dash-card dash-plan-card">
      <div class="dash-card-header"><h2>Trade Plan</h2></div>
      <div class="dash-plan-grid">
        <div class="dash-plan-box"><span>Entry</span><strong id="dashEntry">3351–3354</strong></div>
        <div class="dash-plan-box"><span>Invalidation</span><strong id="dashInvalidation">Below 3344</strong></div>
        <div class="dash-plan-box"><span>TP1</span><strong id="dashTp1">3362</strong></div>
        <div class="dash-plan-box"><span>TP2</span><strong id="dashTp2">3371</strong></div>
        <div class="dash-plan-box wide"><span>Min R:R</span><strong id="dashMinRr">1 : 2.1</strong></div>
      </div>
    </article>

    <article class="dash-card dash-evidence-card">
      <div class="dash-card-header"><h2>Evidence / Confluence</h2></div>
      <div id="dashEvidenceChips" class="dash-chip-group"></div>
      <div class="dash-metric-row dash-score-row"><span>Confluence Score</span><strong id="dashConfluenceScore">0 / 5</strong></div>
    </article>

    <article class="dash-card dash-agent-card">
      <div class="dash-card-header"><h2>Agent Panel</h2></div>
      <div id="dashAgentRows" class="dash-agent-list"></div>
    </article>
  </section>

  <div class="steps">
    <div class="step active" onclick="goTo(0)"><span class="step-num">01</span>Setup</div>
    <div class="step" onclick="goTo(1)"><span class="step-num">02</span>Charts</div>
    <div class="step" onclick="goTo(2)"><span class="step-num">03</span>Context</div>
    <div class="step" onclick="goTo(3)"><span class="step-num">04</span>Pre-Ticket</div>
    <div class="step" onclick="goTo(4)"><span class="step-num">05</span>Test Mode</div>
    <div class="step" onclick="goTo(5)"><span class="step-num">06</span>Output</div>
    <div class="step" onclick="goTo(6)"><span class="step-num">07</span>AAR</div>
  </div>

  <!-- ════════════════════════════════════════
       STEP 1: SETUP
  ════════════════════════════════════════ -->
  <div class="section active" id="section-0">
    <div class="card">
      <div class="card-label">Asset, Session & Platform</div>

      <label>Asset / Ticker</label>
      <input type="text" id="asset" placeholder="e.g. XAUUSD, EURUSD, BTCUSDT" oninput="onAssetInput()">
      <div class="suggestions">
        <span class="sug-pill" onclick="setAsset('XAUUSD')">XAUUSD</span>
        <span class="sug-pill" onclick="setAsset('EURUSD')">EURUSD</span>
        <span class="sug-pill" onclick="setAsset('GBPUSD')">GBPUSD</span>
        <span class="sug-pill" onclick="setAsset('BTCUSDT')">BTCUSDT</span>
        <span class="sug-pill" onclick="setAsset('US30')">US30</span>
        <span class="sug-pill" onclick="setAsset('NAS100')">NAS100</span>
      </div>

      <div class="row">
        <div>
          <label>Session</label>
          <select id="session" onchange="syncOutput()">
            <option value="">— Select —</option>
            <option>London Open</option>
            <option>London Mid</option>
            <option>NY Open</option>
            <option>NY AM</option>
            <option>NY PM / Close</option>
            <option>Asia Session</option>
            <option>Swing / Multi-day</option>
          </select>
        </div>
        <div>
          <label>Execution Horizon</label>
          <select id="execHorizon" onchange="syncOutput()">
            <option value="">— Select —</option>
            <option>Scalp</option>
            <option>Intraday</option>
            <option>Swing</option>
            <option>All ideas</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Broker / Platform</label>
          <select id="broker" onchange="syncOutput()">
            <option>TradingView</option>
            <option>MT5</option>
            <option>cTrader</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label>Candle Type</label>
          <select id="candleType" onchange="syncOutput()">
            <option>Normal</option>
            <option>Heikin Ashi</option>
            <option>Renko</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Chart Timezone</label>
          <input type="text" id="chartTimezone" placeholder="e.g. UTC+3, NY time, Server time" oninput="syncOutput()">
        </div>
        <div>
          <label>Price Now (optional)</label>
          <input type="text" id="priceNow" placeholder="e.g. 2934.65" oninput="syncOutput()">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Market Regime</label>
          <select id="regime" onchange="syncOutput()">
            <option value="">— Select —</option>
            <option>Trending</option>
            <option>Ranging</option>
            <option>Volatile / News-driven</option>
            <option>Unsure — please assess</option>
          </select>
        </div>
        <div>
          <label>Bias Horizon</label>
          <select id="biasHorizon" onchange="syncOutput()">
            <option value="">— Select —</option>
            <option>HTF swing bias (D/4H)</option>
            <option>Intraday bias (1H/30m)</option>
            <option>Scalp bias (15m/5m)</option>
            <option>Mixed / counter-trend acceptable</option>
          </select>
        </div>
      </div>

      <!-- G4: Counter-trend toggle -->
      <div class="row">
        <div>
          <label>Allow Counter-Trend Ideas?</label>
          <select id="counterTrendMode" onchange="syncOutput()">
            <option value="Strict HTF-only">Strict HTF-only (no CT ideas)</option>
            <option value="Mixed" selected>Mixed (CT if strongly justified)</option>
            <option value="Full OK">Full OK (any direction)</option>
          </select>
        </div>
      </div>

      <label>My Current Bias (optional)</label>
      <div class="bias-row">
        <div class="bias-btn" data-val="BULLISH" onclick="setBias(this)">▲ Bullish</div>
        <div class="bias-btn" data-val="BEARISH" onclick="setBias(this)">▼ Bearish</div>
        <div class="bias-btn" data-val="NEUTRAL" onclick="setBias(this)">— Neutral</div>
      </div>

      <div class="toggle-wrap">
        <div class="toggle-left">
          <div class="toggle-title">Permission to say "No Trade"</div>
          <div class="toggle-sub">If conditions are poor, WAIT is preferred over a forced ticket.</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="noTradeToggle" onchange="syncOutput()" checked>
          <span class="slider-sw"></span>
        </label>
      </div>

      <div class="row">
        <div>
          <label>Min R:R Required</label>
          <select id="minRR" onchange="syncOutput()">
            <option value="">— Any —</option>
            <option value="1.5">1.5R minimum</option>
            <option value="2">2R minimum</option>
            <option value="2.5">2.5R minimum</option>
            <option value="3">3R minimum</option>
          </select>
        </div>
        <div>
          <label>Allow R:R Exception?</label>
          <select id="rrException" onchange="toggleRRJustification(); syncOutput()">
            <option value="no">No — strict filter</option>
            <option value="yes">Yes — if win-rate logic is strong</option>
          </select>
        </div>
      </div>
      <div id="rrJustWrap" style="display:none;">
        <label>Exception Justification (required)</label>
        <input type="text" id="rrJustification" placeholder="e.g. High-probability mean reversion with historical 70%+ hit rate" oninput="syncOutput()">
      </div>

      <div class="row">
        <div>
          <label>Max Stop Distance (pips / $)</label>
          <input type="text" id="maxStop" placeholder="e.g. 50 pips, $200" oninput="syncOutput()">
        </div>
        <div>
          <label>Spread / Slippage Assumption</label>
          <input type="text" id="spread" placeholder="e.g. 0.3 pips, $0.50" oninput="syncOutput()">
        </div>
      </div>

      <label>Correlation Context (optional)</label>
      <div class="row">
        <div>
          <input type="text" id="correlationNote" placeholder="e.g. DXY strengthening, SPX risk-off" oninput="syncOutput()" style="margin-bottom:0">
        </div>
        <div>
          <select id="correlationConf" onchange="syncOutput()" style="margin-bottom:0">
            <option value="">— Confidence —</option>
            <option value="Low">Low confidence</option>
            <option value="Med">Medium confidence</option>
            <option value="High">High confidence</option>
          </select>
        </div>
      </div>
      <p class="hint" style="margin-top:6px;">Used as secondary confirmation only — never primary justification.</p>

      <label>Persona Override (optional)</label>
      <select id="persona" onchange="syncOutput()">
        <option value="">Default — ruthless prop trader</option>
        <option value="ICT purist">ICT purist</option>
        <option value="SMC + Volume Profile">SMC + Volume Profile</option>
        <option value="Pure price action">Pure price action</option>
        <option value="Wyckoff methodology">Wyckoff methodology</option>
      </select>

      <!-- G9: Shadow Mode toggle -->
      <div class="toggle-wrap" style="margin-top:8px;border:1px solid rgba(59,111,255,0.35);border-radius:4px;padding:12px 16px;background:rgba(59,111,255,0.05);">
        <div class="toggle-left">
          <div class="toggle-title" style="color:var(--accent);">● Shadow Mode — Paper Trade</div>
          <div class="toggle-sub">Zero capital risk. Run the full analysis as a calibration exercise. Record the actual price outcome after 24h/48h to track AI edge accuracy over time.</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="shadowModeToggle" onchange="onShadowModeChange()">
          <span class="slider-sw"></span>
        </label>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" onclick="goTo(1)">Next: Charts →</button>
    </div>
  </div>

  <!-- ════════════════════════════════════════
       STEP 2: CHARTS
       Lens-aware architecture: 3 clean price charts + optional indicator overlays
       Hard cap: 7 screenshots maximum per run.
  ════════════════════════════════════════ -->
  <div class="section" id="section-1">
    <div class="card">
      <div class="card-label">Chart Screenshots — Clean Price</div>
      <p class="step-note">Upload a <strong>clean price chart</strong> (no indicator overlays) for each timeframe. All three slots are required for the best analysis. Optional indicator overlays are revealed below.</p>

      <div class="tf-grid">
        <div class="upload-zone" id="zone-htf" onclick="triggerUpload('upload-htf')">
          <input type="file" id="upload-htf" accept="image/*" onchange="handleUpload(this,'zone-htf','label-htf','htf')">
          <span class="upload-tf-label">4H / 1H</span>
          <span class="upload-desc">Clean price — HTF bias</span>
          <img class="preview-img" id="prev-htf">
          <span class="upload-filename" id="label-htf"></span>
        </div>
        <div class="upload-zone" id="zone-m15" onclick="triggerUpload('upload-m15')">
          <input type="file" id="upload-m15" accept="image/*" onchange="handleUpload(this,'zone-m15','label-m15','m15')">
          <span class="upload-tf-label">15M</span>
          <span class="upload-desc">Clean price — structure</span>
          <img class="preview-img" id="prev-m15">
          <span class="upload-filename" id="label-m15"></span>
        </div>
        <div class="upload-zone" id="zone-m5" onclick="triggerUpload('upload-m5')">
          <input type="file" id="upload-m5" accept="image/*" onchange="handleUpload(this,'zone-m5','label-m5','m5')">
          <span class="upload-tf-label">5M</span>
          <span class="upload-desc">Clean price — entry context</span>
          <img class="preview-img" id="prev-m5">
          <span class="upload-filename" id="label-m5"></span>
        </div>
      </div>

      <div class="upload-warning" id="uploadWarning">
        No screenshots uploaded. The AI will still analyse but quality will be limited.
      </div>

      <div class="divider"></div>

      <!-- Indicator Overlays — optional, progressive disclosure -->
      <div class="toggle-wrap" id="overlayToggleWrap">
        <div class="toggle-left">
          <div class="toggle-title">Include indicator overlays</div>
          <div class="toggle-sub">Optional. Enables isolated analysis comparisons against the clean-price baseline. Keep each overlay type consistent and clearly labeled.</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="overlayToggle" onchange="toggleOverlaySlot(this.checked)">
          <span class="slider-sw"></span>
        </label>
      </div>

      <div id="overlaySlotWrap" style="display:none;">
        <p class="hint" style="margin-top:0; margin-bottom:8px;">Upload any optional overlay screenshots you want the model to compare separately from clean price. 15M is preferred for ICT / structure / trendline overlays. Custom can be any timeframe if clearly annotated.</p>
        <div class="tf-grid">
          <div class="upload-zone upload-zone-overlay" id="zone-m15overlay" onclick="triggerUpload('upload-m15overlay')">
            <input type="file" id="upload-m15overlay" accept="image/*" onchange="handleUpload(this,'zone-m15overlay','label-m15overlay','m15overlay')">
            <span class="upload-tf-label">15M — ICT Overlay</span>
            <span class="upload-desc">Indicator overlay · secondary evidence · 15M only</span>
            <img class="preview-img" id="prev-m15overlay">
            <span class="upload-filename" id="label-m15overlay"></span>
          </div>
          <div class="upload-zone upload-zone-overlay" id="zone-m15structure" onclick="triggerUpload('upload-m15structure')">
            <input type="file" id="upload-m15structure" accept="image/*" onchange="handleUpload(this,'zone-m15structure','label-m15structure','m15structure')">
            <span class="upload-tf-label">15M — Market Structure Overlay</span>
            <span class="upload-desc">Structure marks (BOS/MSS/HH-HL/LH-LL) · comparison lens</span>
            <img class="preview-img" id="prev-m15structure">
            <span class="upload-filename" id="label-m15structure"></span>
          </div>
          <div class="upload-zone upload-zone-overlay" id="zone-m15trendline" onclick="triggerUpload('upload-m15trendline')">
            <input type="file" id="upload-m15trendline" accept="image/*" onchange="handleUpload(this,'zone-m15trendline','label-m15trendline','m15trendline')">
            <span class="upload-tf-label">15M — Trendline Overlay</span>
            <span class="upload-desc">Trendline / channel annotations · comparison lens</span>
            <img class="preview-img" id="prev-m15trendline">
            <span class="upload-filename" id="label-m15trendline"></span>
          </div>
          <div class="upload-zone upload-zone-overlay" id="zone-customoverlay" onclick="triggerUpload('upload-customoverlay')">
            <input type="file" id="upload-customoverlay" accept="image/*" onchange="handleUpload(this,'zone-customoverlay','label-customoverlay','customoverlay')">
            <span class="upload-tf-label">Custom Overlay</span>
            <span class="upload-desc">Any custom indicator/drawing set · label in context notes</span>
            <img class="preview-img" id="prev-customoverlay">
            <span class="upload-filename" id="label-customoverlay"></span>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div>
          <label>HTF Context (price location)</label>
          <select id="htfContextSetup" onchange="syncOutput()">
            <option value="">— Select —</option>
            <option>At HTF demand / support</option>
            <option>At HTF supply / resistance</option>
            <option>Mid-range</option>
            <option>Extended above HTF structure</option>
            <option>Extended below HTF structure</option>
            <option>Breaking out of range</option>
          </select>
        </div>
        <div>
          <label>Chart Cleanliness (clean slots)</label>
          <select id="chartCleanliness" onchange="syncOutput()">
            <option value="Clean">Clean — no drawings</option>
            <option value="Light">Light drawings — some annotations</option>
            <option value="Heavy">Heavy drawings — AI should note drawings present</option>
          </select>
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo(0)">← Back</button>
      <button class="btn btn-primary" onclick="goToChartsNext()">Next: Context →</button>
    </div>
  </div>

  <!-- ════════════════════════════════════════
       STEP 3: CONTEXT + ANALYSIS REQUESTS
  ════════════════════════════════════════ -->
  <div class="section" id="section-2">
    <div class="card">
      <div class="card-label">Market Context</div>

      <label>Indicators on chart</label>
      <input type="text" id="indicators" placeholder="e.g. EMA 50/200, ICT FVG, Fibonacci, SR Zones" oninput="syncOutput()">

      <label>Key levels I already see</label>
      <textarea id="levels" placeholder="e.g. Resistance at 2950 (previous swing high). Support at 2898 (HTF demand zone). Trendline from Jan lows." oninput="syncOutput()"></textarea>

      <label>Upcoming news / events</label>
      <input type="text" id="news" placeholder="e.g. CPI tomorrow 8:30 ET, FOMC next week" oninput="syncOutput()">

      <label>Any open positions?</label>
      <input type="text" id="position" placeholder="e.g. Long XAUUSD from 2880, SL at 2855" oninput="syncOutput()">
    </div>

    <div class="card">
      <div class="card-label">Analysis Requests</div>
      <div class="checkbox-grid" id="requests">
        <label class="checkbox-item checked" onclick="toggleCheck(this)">
          <input type="checkbox" checked><div class="check-box">✓</div>
          <span class="check-text">Trend & key levels per TF</span>
        </label>
        <label class="checkbox-item checked" onclick="toggleCheck(this)">
          <input type="checkbox" checked><div class="check-box">✓</div>
          <span class="check-text">Primary trade ticket</span>
        </label>
        <label class="checkbox-item checked" onclick="toggleCheck(this)">
          <input type="checkbox" checked><div class="check-box">✓</div>
          <span class="check-text">No-trade conditions</span>
        </label>
        <label class="checkbox-item checked" onclick="toggleCheck(this)">
          <input type="checkbox" checked><div class="check-box">✓</div>
          <span class="check-text">Kill-switch conditions</span>
        </label>
        <label class="checkbox-item" onclick="toggleCheck(this)">
          <input type="checkbox"><div class="check-box"></div>
          <span class="check-text">Conditional alternative ticket</span>
        </label>
        <label class="checkbox-item" onclick="toggleCheck(this)">
          <input type="checkbox"><div class="check-box"></div>
          <span class="check-text">Liquidity analysis</span>
        </label>
        <label class="checkbox-item" onclick="toggleCheck(this)">
          <input type="checkbox"><div class="check-box"></div>
          <span class="check-text">HTF/LTF confluence</span>
        </label>
        <label class="checkbox-item" onclick="toggleCheck(this)">
          <input type="checkbox"><div class="check-box"></div>
          <span class="check-text">Invalidation scenarios</span>
        </label>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo(1)">← Back</button>
      <button class="btn btn-primary" onclick="goTo(3)">Next: Pre-Ticket →</button>
    </div>
  </div>

  <!-- ════════════════════════════════════════
       STEP 4: PRE-TICKET CHECKLIST (mandatory gate)
  ════════════════════════════════════════ -->
  <div class="section" id="section-3">
    <div class="card">
      <div class="card-label amber">Pre-Ticket Checklist <span class="gate-badge" id="gateBadge">INCOMPLETE</span></div>
      <p class="step-note">Complete all 8 fields. This is your structural read before the AI commits to a ticket. The gate logic will warn you if conditions suggest WAIT.</p>

      <!-- 1. HTF State -->
      <div class="ptc-row">
        <label>1 · HTF State</label>
        <div class="radio-group" id="rg-htfState">
          <div class="radio-opt" data-val="Trending" data-sel="sel-trending" onclick="selectRadio('htfState',this)">Trending</div>
          <div class="radio-opt" data-val="Ranging" data-sel="sel-ranging" onclick="selectRadio('htfState',this)">Ranging</div>
          <div class="radio-opt" data-val="Transition" data-sel="sel-transition" onclick="selectRadio('htfState',this)">Transition</div>
        </div>
      </div>

      <!-- 2. HTF Location -->
      <div class="ptc-row">
        <label>2 · HTF Location</label>
        <div class="radio-group" id="rg-htfLocation">
          <div class="radio-opt" data-val="At POI" data-sel="sel-poi" onclick="selectRadio('htfLocation',this)">At POI</div>
          <div class="radio-opt" data-val="Mid-range" data-sel="sel-midrange" onclick="selectRadio('htfLocation',this)">Mid-range</div>
          <div class="radio-opt" data-val="At extremes" data-sel="sel-extremes" onclick="selectRadio('htfLocation',this)">At extremes</div>
        </div>
      </div>

      <!-- 3. LTF Alignment -->
      <div class="ptc-row">
        <label>3 · LTF Alignment</label>
        <div class="radio-group" id="rg-ltfAlignment">
          <div class="radio-opt" data-val="Aligned" data-sel="sel-aligned" onclick="selectRadio('ltfAlignment',this)">Aligned with HTF</div>
          <div class="radio-opt" data-val="Counter-trend" data-sel="sel-counter" onclick="selectRadio('ltfAlignment',this)">Counter-trend</div>
          <div class="radio-opt" data-val="Mixed" data-sel="sel-mixed" onclick="selectRadio('ltfAlignment',this)">Mixed</div>
        </div>
      </div>

      <!-- 4. Liquidity Context -->
      <div class="ptc-row">
        <label>4 · Liquidity Context</label>
        <div class="radio-group" id="rg-liquidityContext">
          <div class="radio-opt" data-val="Near obvious highs/lows" data-sel="sel-nearliq" onclick="selectRadio('liquidityContext',this)">Near obvious highs/lows</div>
          <div class="radio-opt" data-val="Equilibrium" data-sel="sel-eq" onclick="selectRadio('liquidityContext',this)">Equilibrium</div>
          <div class="radio-opt" data-val="None identified" data-sel="sel-none" onclick="selectRadio('liquidityContext',this)">None identified</div>
        </div>
      </div>

      <!-- 5. Volatility / News Risk -->
      <div class="ptc-row">
        <label>5 · Volatility / News Risk</label>
        <div class="radio-group" id="rg-volRisk">
          <div class="radio-opt" data-val="Normal" data-sel="sel-normal" onclick="selectRadio('volRisk',this)">Normal</div>
          <div class="radio-opt" data-val="Elevated" data-sel="sel-elevated" onclick="selectRadio('volRisk',this)">Elevated</div>
        </div>
      </div>

      <!-- 6. Execution Quality -->
      <div class="ptc-row">
        <label>6 · Execution Quality</label>
        <div class="radio-group" id="rg-execQuality">
          <div class="radio-opt" data-val="Clean" data-sel="sel-clean" onclick="selectRadio('execQuality',this)">Clean</div>
          <div class="radio-opt" data-val="Messy" data-sel="sel-messy" onclick="selectRadio('execQuality',this)">Messy</div>
          <div class="radio-opt" data-val="Chop" data-sel="sel-chop" onclick="selectRadio('execQuality',this)">Chop</div>
        </div>
      </div>

      <!-- 7. My Conviction Before AI -->
      <div class="ptc-row">
        <label>7 · My Conviction Level (before AI)</label>
        <div class="radio-group" id="rg-conviction">
          <div class="radio-opt" data-val="Very High" data-sel="sel-veryhigh" onclick="selectRadio('conviction',this)">Very High</div>
          <div class="radio-opt" data-val="High" data-sel="sel-high" onclick="selectRadio('conviction',this)">High</div>
          <div class="radio-opt" data-val="Medium" data-sel="sel-medium" onclick="selectRadio('conviction',this)">Medium</div>
          <div class="radio-opt" data-val="Low" data-sel="sel-low" onclick="selectRadio('conviction',this)">Low</div>
        </div>
      </div>

      <!-- 8. Personal Edge Tag -->
      <div class="ptc-row">
        <label>8 · My Personal Edge Tag on This Setup</label>
        <div class="radio-group" id="rg-edgeTag">
          <div class="radio-opt" data-val="High-probability pullback" data-sel="sel-aligned" onclick="selectRadio('edgeTag',this)">Pullback</div>
          <div class="radio-opt" data-val="Liquidity grab" data-sel="sel-poi" onclick="selectRadio('edgeTag',this)">Liquidity grab</div>
          <div class="radio-opt" data-val="FVG reclaim" data-sel="sel-trending" onclick="selectRadio('edgeTag',this)">FVG reclaim</div>
          <div class="radio-opt" data-val="Structure BOS" data-sel="sel-transition" onclick="selectRadio('edgeTag',this)">Structure BOS</div>
          <div class="radio-opt" data-val="Range boundary" data-sel="sel-ranging" onclick="selectRadio('edgeTag',this)">Range boundary</div>
          <div class="radio-opt" data-val="Other" data-sel="sel-none" onclick="selectRadio('edgeTag',this)">Other</div>
        </div>
      </div>

      <!-- Confluence Slider -->
      <div class="slider-wrap">
        <div class="slider-header">
          <div class="slider-label">Confluence Score (your gut-feel, pre-AI)</div>
          <div class="slider-val" id="confVal">7</div>
        </div>
        <input type="range" id="confluenceScore" min="1" max="10" value="7" oninput="onSlider()">
        <div class="slider-subtext">1 = very weak · 5 = moderate · 10 = highest conviction. This will be tracked vs outcomes.</div>
      </div>

      <!-- Gate Status -->
      <div class="gate-status" id="gateStatus">
        <div class="gate-dot"></div>
        <span id="gateText">Complete all 8 fields to see gate decision.</span>
      </div>

      <!-- WAIT Panel (shown when gate logic fires) -->
      <div class="wait-panel" id="waitPanel">
        <label>⚠ WAIT Reason Code</label>
        <select id="waitReason" onchange="syncOutput()">
          <option value="">— Select reason —</option>
          <option>Chop / range noise</option>
          <option>HTF-LTF conflict</option>
          <option>No POI / poor R:R</option>
          <option>News risk / volatility</option>
          <option>Already moved / late trend</option>
        </select>
        <label>Re-entry Condition (what would change WAIT to trade?)</label>
        <input type="text" id="reentryCondition" placeholder="e.g. Price sweeps 2890 liquidity and reclaims 2895 on 15m close" oninput="syncOutput()">
        <label>Time horizon for re-evaluation</label>
        <input type="text" id="reentryTime" placeholder="e.g. Re-check in 2H at NY open" oninput="syncOutput()">
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo(2)">← Back</button>
      <button class="btn btn-primary" onclick="goTo(4)">Next: Test Mode →</button>
    </div>
  </div>

  <!-- ════════════════════════════════════════
       STEP 5: TEST / PREDICTION MODE
  ════════════════════════════════════════ -->
  <div class="section" id="section-4">
    <div class="card">
      <div class="card-label amber">Test / Prediction Mode — Your Call Before AI</div>
      <p class="step-note">Record your prediction before seeing AI analysis. These values pre-fill the structured TRADE TICKET block in the generated prompt and are saved in JSON exports.</p>

      <div class="row">
        <div>
          <label>Decision Mode</label>
          <select id="decisionMode" onchange="onDecisionModeChange(this)">
            <option value="LONG">LONG</option>
            <option value="SHORT">SHORT</option>
            <option value="WAIT" selected>WAIT</option>
            <option value="CONDITIONAL">CONDITIONAL</option>
          </select>
        </div>
        <div>
          <label>Ticket Type</label>
          <select id="ticketType" onchange="syncOutput()">
            <option value="Zone ticket">Zone ticket (default)</option>
            <option value="Exact ticket">Exact ticket</option>
          </select>
        </div>
      </div>

      <div id="conditionalWrap" style="display:none;">
        <label>Conditional Alternative (if Decision = CONDITIONAL)</label>
        <textarea id="conditionalText" placeholder="Describe the alternative scenario or trigger that would change the direction..." oninput="syncOutput()"></textarea>
      </div>

      <div class="row">
        <div>
          <label>Entry Type</label>
          <select id="entryType" onchange="syncOutput()">
            <option value="Market">Market</option>
            <option value="Limit" selected>Limit</option>
            <option value="Stop">Stop</option>
          </select>
        </div>
        <div>
          <label>Entry Trigger Type</label>
          <select id="entryTrigger" onchange="syncOutput()">
            <option value="Pullback to zone">Pullback to zone</option>
            <option value="Break + retest">Break + retest</option>
            <option value="Sweep + reclaim">Sweep + reclaim</option>
            <option value="Close above/below level">Close above/below level</option>
            <option value="Momentum shift (MSS/BOS)">Momentum shift (MSS/BOS)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Confirmation Timeframe</label>
          <select id="confTF" onchange="syncOutput()">
            <option value="1m">1m</option>
            <option value="5m">5m</option>
            <option value="15m">15m</option>
            <option value="1H" selected>1H</option>
          </select>
        </div>
        <div>
          <label>Stop Logic</label>
          <select id="stopLogic" onchange="syncOutput()">
            <option value="Below swing low / above swing high">Below swing low / above swing high</option>
            <option value="Below zone">Below zone</option>
            <option value="ATR-based">ATR-based</option>
            <option value="Structure-based + buffer">Structure-based + buffer</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Time-in-Force</label>
          <select id="timeInForce" onchange="syncOutput()">
            <option value="This session">This session</option>
            <option value="Next 1H">Next 1H</option>
            <option value="24H">24H</option>
            <option value="Custom">Custom</option>
          </select>
        </div>
        <div>
          <label>Max Entry Attempts</label>
          <select id="maxAttempts" onchange="syncOutput()">
            <option value="1">1</option>
            <option value="2" selected>2</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>
      <div class="card-label" style="font-size:11px;margin-bottom:10px;">Price Levels — Your Prediction</div>

      <div class="row">
        <div>
          <label>Entry Zone Low</label>
          <input type="number" id="entryPriceMin" placeholder="e.g. 2895.00" oninput="syncOutput()" step="any">
        </div>
        <div>
          <label>Entry Zone High</label>
          <input type="number" id="entryPriceMax" placeholder="e.g. 2905.00" oninput="syncOutput()" step="any">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Stop Price</label>
          <input type="number" id="stopPrice" placeholder="e.g. 2875.00" oninput="syncOutput()" step="any">
        </div>
        <div>
          <label>Stop Rationale</label>
          <input type="text" id="stopRationale" placeholder="e.g. Below swing low at 2870" oninput="syncOutput()">
        </div>
      </div>

      <div class="row">
        <div>
          <label>TP1 Price</label>
          <input type="number" id="tp1Price" placeholder="e.g. 2935.00" oninput="syncOutput()" step="any">
        </div>
        <div>
          <label>TP1 Rationale</label>
          <input type="text" id="tp1Rationale" placeholder="e.g. Previous swing high / supply zone" oninput="syncOutput()">
        </div>
      </div>

      <div class="row">
        <div>
          <label>TP2 Price (optional)</label>
          <input type="number" id="tp2Price" placeholder="e.g. 2960.00" oninput="syncOutput()" step="any">
        </div>
        <div>
          <label>TP2 Rationale (optional)</label>
          <input type="text" id="tp2Rationale" placeholder="e.g. HTF supply / weekly target" oninput="syncOutput()">
        </div>
      </div>

      <label>Entry Notes (optional)</label>
      <input type="text" id="entryNotes" placeholder="e.g. Wait for 15m engulfing candle before entry" oninput="syncOutput()">

      <div class="toggle-wrap">
        <div class="toggle-left">
          <div class="toggle-title">Ask AI for missing info before committing a trade</div>
          <div class="toggle-sub">AI will request any data gaps before producing a ticket.</div>
        </div>
        <label class="switch">
          <input type="checkbox" id="askMissing" onchange="syncOutput()" checked>
          <span class="slider-sw"></span>
        </label>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo(3)">← Back to Pre-Ticket</button>
      <button class="btn btn-primary" onclick="buildAndShow()">Generate V3 Prompt →</button>
    </div>
  </div>

  <!-- ════════════════════════════════════════
       STEP 6: OUTPUT
  ════════════════════════════════════════ -->
  <div class="section" id="section-5">
    <div class="card">
      <div class="card-label green">Generated Prompt — V3</div>
      <p class="step-note">Copy & paste into Claude. Attach your chart screenshots in the same message. Ticket ID and timestamp are embedded.</p>

      <div class="output-panel">
        <div class="output-header">
          <span class="output-title">● PROMPT READY · <span id="outputTicketId">—</span></span>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="copy-btn" onclick="copyPrompt()">Copy Prompt</button>
            <button class="export-btn" onclick="exportHTML()">Download HTML</button>
            <button class="export-btn" onclick="exportPDF()">Print / PDF</button>
            <button class="export-btn" onclick="exportJSONBackup()">Export JSON</button>
            <button class="export-btn" onclick="exportAnalyticsPDF()">Export Analytics PDF</button>
          </div>
        </div>
        <div id="outputText">Fill in the form steps to generate your V3 prompt...</div>
      </div>
    </div>

    <div class="card">
      <div class="card-label">Charts to Attach</div>
      <div id="attachChecklist" style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--muted);line-height:2.1;white-space:pre;"></div>
    </div>

    <!-- G5 + G8: Record AI response data after reading the AI's output -->
    <div class="card">
      <div class="card-label">G5 / G8 — AI Response Record</div>
      <p class="step-note">Fill in after reading the AI response. These fields are stored in your ticket for AAR comparison and weekly review analysis.</p>
      <div class="row">
        <div>
          <label>AI's Raw Bias Verdict (from chart narrative)</label>
          <select id="rawAIReadBias" onchange="syncOutput()">
            <option value="">— Not yet recorded —</option>
            <option value="Bullish">Bullish</option>
            <option value="Bearish">Bearish</option>
            <option value="Neutral">Neutral</option>
            <option value="Range">Range</option>
          </select>
        </div>
        <div>
          <label>AI Confidence Score (0.0–1.0, from AI response)</label>
          <input type="number" id="aiEdgeScore" min="0" max="1" step="0.01" placeholder="e.g. 0.72" oninput="syncOutput()">
          <p class="hint" style="margin-top:4px;">Record the AI's overall confidence/edge score if provided. Used in AAR comparison.</p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-label green">G11 — API Bridge (POST /analyse)</div>
      <p class="step-note">Send current form + chart uploads to AI Analyst API and render returned <code>FinalVerdict</code>.</p>
      <label>Analysis Server URL</label>
      <input type="text" id="analysisServerUrl" placeholder="http://localhost:8000" value="http://localhost:8000">
      <div class="btn-row" style="margin-top:10px;">
        <button class="btn btn-primary" onclick="runBridgeAnalyse()">Run API Analysis</button>
      </div>
      <p id="analysisBridgeStatus" class="hint" style="margin-top:8px;">Idle.</p>
      <div id="analysisVerdictCard" style="margin-top:10px;"></div>
    </div>

    <!-- G9: Shadow Outcome — visible only when Shadow Mode is active -->
    <div class="card" id="shadowOutcomeCard" style="display:none;border-color:rgba(59,111,255,0.4);">
      <div class="card-label" style="color:var(--accent);">G9 — Shadow Outcome</div>
      <p class="step-note">This is a shadow (paper) trade. After your capture window expires, paste the actual price to calibrate AI edge accuracy. The system will compute R outcome and whether TP1/stop was hit.</p>
      <div class="row">
        <div>
          <label>Capture Window</label>
          <select id="shadowCaptureWindow" onchange="onShadowCaptureWindowChange()">
            <option value="24">24 hours</option>
            <option value="48">48 hours</option>
          </select>
        </div>
        <div>
          <label>Capture Deadline</label>
          <div id="shadowDeadlineDisplay" style="font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--muted);padding:10px 0;line-height:1.6;">—</div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Actual Price at Capture (paste from chart)</label>
          <input type="number" id="shadowOutcomePrice" placeholder="e.g. 2945.00" step="any" oninput="onShadowOutcomeInput()">
        </div>
        <div>
          <label>Calculated PnL (R)</label>
          <div id="shadowPnlDisplay" style="font-family:'IBM Plex Mono',monospace;font-size:22px;font-weight:600;padding:6px 0;color:var(--muted);">—</div>
        </div>
      </div>
      <div class="row" id="shadowHitRow" style="display:none;">
        <div>
          <label>Hit Target (TP1)?</label>
          <div id="shadowHitTarget" style="font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:600;padding:6px 0;color:var(--muted);">—</div>
        </div>
        <div>
          <label>Hit Stop?</label>
          <div id="shadowHitStop" style="font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:600;padding:6px 0;color:var(--muted);">—</div>
        </div>
      </div>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn btn-ghost shadow-save-btn" onclick="saveShadowOutcome()">Save Shadow Outcome →</button>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo(4)">← Edit Test Mode</button>
      <button class="btn btn-ghost" onclick="goTo(6)">After-Action Review →</button>
      <button class="btn btn-primary" onclick="resetForm()">New Ticket</button>
    </div>
  </div>

  <!-- ════════════════════════════════════════
       STEP 7: AFTER-ACTION REVIEW (AAR)
       G3 — Post-trade review linked to ticket by ticketId
  ════════════════════════════════════════ -->
  <div class="section" id="section-6">

    <!-- G8: Revision banner — shown when this ticket was started via "Revise This Ticket" -->
    <div id="revisionBanner" style="display:none;background:rgba(251,191,36,0.12);border:1px solid var(--amber);border-radius:6px;padding:10px 14px;margin-bottom:12px;font-size:12px;color:var(--amber);">
      Revising ticket: <strong id="revisionSourceId">—</strong> — this ticket will be linked as a child revision. <code>revisedFromId</code> will be included in the JSON export.
    </div>

    <div class="card">
      <div class="card-label amber">After-Action Review — <span id="aarTicketIdLabel">—</span></div>
      <p class="step-note">Complete after the trade is closed. Honest scoring only — this feeds your edge calibration over time.</p>

      <div class="row">
        <div>
          <label>Outcome</label>
          <select id="aarOutcome" onchange="onAAROutcomeChange(this)">
            <option value="MISSED">MISSED (no fill)</option>
            <option value="WIN">WIN</option>
            <option value="LOSS">LOSS</option>
            <option value="BREAKEVEN">BREAKEVEN</option>
            <option value="SCRATCH">SCRATCH</option>
          </select>
        </div>
        <div>
          <label>Process Verdict</label>
          <select id="aarVerdict" onchange="updateEdgeScore()">
            <option value="PLAN_FOLLOWED">Plan Followed</option>
            <option value="PROCESS_GOOD">Process Good</option>
            <option value="PROCESS_POOR">Process Poor</option>
            <option value="PLAN_VIOLATION">Plan Violation</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Actual Entry Price</label>
          <input type="number" id="aarActualEntry" placeholder="e.g. 2902.50" step="any">
        </div>
        <div>
          <label>Actual Exit Price</label>
          <input type="number" id="aarActualExit" placeholder="e.g. 2935.00" step="any">
        </div>
      </div>

      <div class="row">
        <div>
          <label>R Achieved</label>
          <input type="number" id="aarRachieved" placeholder="e.g. 1.5 or -1.0" step="0.1">
        </div>
        <div>
          <label>Exit Reason</label>
          <select id="aarExitReason">
            <option value="NO_FILL">No Fill</option>
            <option value="TP_HIT">TP Hit</option>
            <option value="SL_HIT">SL Hit</option>
            <option value="TIME_EXIT">Time Exit</option>
            <option value="MANUAL_EXIT">Manual Exit</option>
            <option value="INVALIDATION">Invalidation</option>
          </select>
        </div>
      </div>

      <div class="ptc-row">
        <label>First Touch? (did price touch entry zone on first approach?)</label>
        <div class="radio-group" id="rg-aar-firstTouch">
          <div class="radio-opt" data-val="false" data-sel="sel-counter" onclick="selectAARRadio('firstTouch',this)">No</div>
          <div class="radio-opt" data-val="true" data-sel="sel-aligned" onclick="selectAARRadio('firstTouch',this)">Yes</div>
        </div>
      </div>

      <div class="ptc-row" id="wouldHaveWonWrap" style="display:none;">
        <label>Would Have Won? (only if MISSED or SCRATCH)</label>
        <div class="radio-group" id="rg-aar-wouldHaveWon">
          <div class="radio-opt" data-val="false" data-sel="sel-counter" onclick="selectAARRadio('wouldHaveWon',this)">No</div>
          <div class="radio-opt" data-val="true" data-sel="sel-aligned" onclick="selectAARRadio('wouldHaveWon',this)">Yes</div>
        </div>
      </div>

      <div class="ptc-row">
        <label>Kill Switch Triggered?</label>
        <div class="radio-group" id="rg-aar-killSwitch">
          <div class="radio-opt sel-aligned" data-val="false" data-sel="sel-aligned" onclick="selectAARRadio('killSwitch',this)">No</div>
          <div class="radio-opt" data-val="true" data-sel="sel-counter" onclick="selectAARRadio('killSwitch',this)">Yes</div>
        </div>
      </div>

      <div class="divider"></div>

      <label>Failure Reason Codes (all that apply)</label>
      <div class="checkbox-grid" id="aarFailureCodes">
        <label class="checkbox-item" onclick="toggleCheck(this)">
          <input type="checkbox" data-code="LATE_ENTRY"><div class="check-box"></div>
          <span class="check-text">Late Entry</span>
        </label>
        <label class="checkbox-item" onclick="toggleCheck(this)">
          <input type="checkbox" data-code="OVERSIZED_RISK"><div class="check-box"></div>
          <span class="check-text">Oversized Risk</span>
        </label>
        <label class="checkbox-item" onclick="toggleCheck(this)">
          <input type="checkbox" data-code="IGNORED_GATE"><div class="check-box"></div>
          <span class="check-text">Ignored Gate</span>
        </label>
        <label class="checkbox-item" onclick="toggleCheck(this)">
          <input type="checkbox" data-code="MISREAD_STRUCTURE"><div class="check-box"></div>
          <span class="check-text">Misread Structure</span>
        </label>
        <label class="checkbox-item" onclick="toggleCheck(this)">
          <input type="checkbox" data-code="NEWS_BLINDSPOT"><div class="check-box"></div>
          <span class="check-text">News Blindspot</span>
        </label>
        <label class="checkbox-item" onclick="toggleCheck(this)">
          <input type="checkbox" data-code="EMOTIONAL_EXECUTION"><div class="check-box"></div>
          <span class="check-text">Emotional Execution</span>
        </label>
        <label class="checkbox-item" onclick="toggleCheck(this)">
          <input type="checkbox" data-code="NO_EDGE"><div class="check-box"></div>
          <span class="check-text">No Edge</span>
        </label>
      </div>

      <div class="row">
        <div>
          <label>Psychological Tag</label>
          <select id="aarPsychTag">
            <option value="CALM">Calm</option>
            <option value="DISCIPLINED">Disciplined</option>
            <option value="FOMO">FOMO</option>
            <option value="HESITATION">Hesitation</option>
            <option value="REVENGE">Revenge</option>
            <option value="OVERCONFIDENCE">Overconfidence</option>
            <option value="FATIGUE">Fatigue</option>
          </select>
        </div>
        <div>
          <label>Edge Score (auto-calculated)</label>
          <div class="edge-score-display" id="edgeScoreDisplay">—</div>
        </div>
      </div>

      <div class="slider-wrap">
        <div class="slider-header">
          <div class="slider-label">Post-Trade Confidence (was this the right process?)</div>
          <div class="slider-val" id="aarConfVal">3</div>
        </div>
        <input type="range" id="aarConfidence" min="1" max="5" value="3" oninput="onAARSlider()">
        <div class="slider-subtext">1 = wrong process · 3 = neutral · 5 = right process even if loss</div>
      </div>

      <div class="divider"></div>
      <div class="card-label" style="font-size:11px;margin-bottom:10px;">Checklist Delta — What Changed vs Pre-Trade Read?</div>

      <div class="row">
        <div>
          <label>HTF State (actual)</label>
          <input type="text" id="aarDeltaHtfState" placeholder="e.g. Switched to Ranging after entry">
        </div>
        <div>
          <label>LTF Alignment (actual)</label>
          <input type="text" id="aarDeltaLtfAlignment" placeholder="e.g. Counter-trend signal missed">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Vol Risk (actual)</label>
          <input type="text" id="aarDeltaVolRisk" placeholder="e.g. Elevated — news hit mid-trade">
        </div>
        <div>
          <label>Exec Quality (actual)</label>
          <input type="text" id="aarDeltaExecQuality" placeholder="e.g. Slipped 3 pips on entry">
        </div>
      </div>
      <label>Checklist Delta Notes</label>
      <textarea id="aarDeltaNotes" placeholder="What would you have changed in your pre-trade read with hindsight?"></textarea>

      <div class="divider"></div>
      <div class="card-label" style="font-size:11px;margin-bottom:10px;">Trade Journal Photo (optional)</div>
      <p class="hint">Upload an outcome screenshot. Ticket ID and timestamp will be watermarked onto the image automatically.</p>

      <div class="upload-zone" id="zone-aarPhoto" onclick="triggerUpload('upload-aarPhoto')" style="max-width:320px;">
        <input type="file" id="upload-aarPhoto" accept="image/*" onchange="handleAARPhotoUpload(this)">
        <span class="upload-tf-label">Journal Photo</span>
        <span class="upload-desc">Outcome screenshot — auto-watermarked</span>
        <img class="preview-img" id="prev-aarPhoto" style="display:none;">
        <span class="upload-filename" id="label-aarPhoto"></span>
      </div>
      <canvas id="aarPhotoCanvas" style="display:none;"></canvas>

      <div class="divider"></div>
      <label>AAR Notes <span style="color:var(--red);">*</span></label>
      <textarea id="aarNotes" placeholder="What happened? Was the plan correct? What would you do differently next time?" style="min-height:80px;"></textarea>
    </div>

    <div id="aarOutputWrap" style="display:none;margin-top:16px;">
      <div class="card">
        <div class="card-label green">AAR Prompt — Ready to Paste</div>
        <div class="output-panel">
          <div class="output-header">
            <span class="output-title">● AAR PROMPT READY</span>
            <button class="copy-btn aar-copy-btn" onclick="copyAARPrompt()">Copy AAR Prompt</button>
          </div>
          <div id="aarOutputText" style="white-space:pre-wrap;font-family:'IBM Plex Mono',monospace;font-size:11px;line-height:1.6;color:var(--text);"></div>
        </div>
      </div>
    </div>


    <div class="card">
      <div class="card-label green">G7 / G8 / G10 — Dashboard, Weekly Review & Performance Analytics</div>
      <p class="hint">Upload one or more exported JSON backup files to compute journal stats across tickets.</p>

      <label>Load JSON Backups</label>
      <input type="file" id="dashboardJsonFiles" accept="application/json" multiple>
      <p id="dashboardStatus" class="hint" style="margin-top:6px;"></p>

      <div class="row-3">
        <div class="dashboard-stat"><span>Total Trades</span><strong id="dashTrades">0</strong></div>
        <div class="dashboard-stat"><span>Closed Trades</span><strong id="dashClosedTrades">0</strong></div>
        <div class="dashboard-stat"><span>Win Rate</span><strong id="dashWinRate">0.0%</strong></div>
      </div>
      <div class="row-3">
        <div class="dashboard-stat"><span>Avg R</span><strong id="dashAvgR">0.00</strong></div>
        <div class="dashboard-stat"><span>Expectancy</span><strong id="dashExpectancy">0.00</strong></div>
        <div class="dashboard-stat"><span>Trades / Active Day</span><strong id="dashTradeFreq">0.00</strong></div>
      </div>
      <div class="row">
        <div class="dashboard-stat"><span>Psychological Leakage R</span><strong id="dashPsychLeak">0.00</strong></div>
        <div></div>
      </div>

      <div class="divider"></div>
      <label>Setup Type × Session Heatmap</label>
      <div id="dashboardHeatmap"></div>

      <div class="divider"></div>
      <label>G10 — Equity Curve (R-Based)</label>
      <div id="dashboardEquityCurve"></div>

      <div class="divider"></div>
      <label>G10 — Monthly Breakdown</label>
      <div id="dashboardMonthlyBreakdown"></div>

      <div class="divider"></div>
      <label>G10 — Quarterly Breakdown</label>
      <div id="dashboardQuarterlyBreakdown"></div>

      <div class="divider"></div>
      <label>Weekly Review</label>
      <p class="hint">Generate a structured AI prompt aggregating your week's trades for performance coaching.</p>
      <button class="btn btn-ghost" onclick="showWeeklyPrompt()" style="margin-bottom:8px;">Generate Weekly Review Prompt</button>
      <div id="weeklyOutputWrap" style="display:none;margin-top:8px;">
        <div class="output-panel">
          <div class="output-header">
            <span class="output-title">● WEEKLY REVIEW PROMPT READY</span>
            <button class="copy-btn weekly-copy-btn" onclick="copyWeeklyPrompt()">Copy Prompt</button>
          </div>
          <div id="weeklyOutputText" style="white-space:pre-wrap;font-family:'IBM Plex Mono',monospace;font-size:11px;line-height:1.6;color:var(--text);"></div>
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo(5)">← Back to Output</button>
      <button class="btn btn-ghost" onclick="showAARPrompt()">Generate AAR Prompt</button>
      <button class="btn btn-ghost" onclick="reviseTicket()" title="Start a new ticket linked to this one as a revision">Revise This Ticket</button>
      <button class="btn btn-primary" onclick="exportJSONBackup()">Export Full JSON (with AAR)</button>
    </div>
  </div>

</main>
<script type="module" src="./scripts/main.js"></script>
</body>
</html>
